digraph G {
    subgraph cluster0 {
        state[label="Global Program State"]
    }

    subgraph cluster1 {
        label="Main Thread"
        start[label="Start"]
        spawn1[label="Spawn Thread #1"]
        spawn2[label="Spawn Thread #2"]
        join[label="Wait for threads to finish"]
        dosomething[label="Do something"]
        end[label="Exit"]

        start -> spawn1
        spawn1 -> spawn2
        spawn2 -> join
        join -> dosomething
        dosomething -> state
        dosomething -> end
    }

    spawn1 -> cond1[label="Imidiately Returns"]
    spawn2 -> setstate[label="Imidiately Returns"]

    subgraph cluster2 {
        label="Thread #1"
        cond1[label="If state is X"]
        condhold1[label="Do something with X and change state to Y"]
        condfail1[label="Wait and check again"]
        exitthread1[label="Work is done - exit"]

        cond1 -> condhold1
        condhold1 -> state
        cond1 -> condfail1
        condfail1 -> cond1
        condhold1 -> exitthread1
    }

    subgraph cluster3 {
        label="Thread #2"
        setstate[label="Set state to X"]
        wait2[label="Wait for state to change to Y"]
        body2[label="Do something with Y"]
        exitthread2[label="Work is done - exit"]

        setstate -> wait2
        setstate -> state
        wait2 -> body2
        body2 -> exitthread2
    }
}
